// Code generated by protoc-gen-go-http-server-interface. DO NOT EDIT.
package {{ .PackageName }}

import (
	"errors"
	"net/http"
	"strings"
)

// Middleware represents a middleware function that wraps an http.Handler.
type Middleware func(http.Handler) http.Handler

// Routes defines the minimal interface for route registration.
type Routes interface {
	// HandleFunc registers a handler function for the given method and pattern.
	HandleFunc(method, pattern string, handler http.HandlerFunc, middlewares ...Middleware)
}

// Router extends Routes with grouping and middleware support.
type Router interface {
	Routes
	// Group creates a sub-router with the given prefix.
	Group(prefix string, middlewares ...Middleware) Router
	// Use appends middlewares to the chain.
	Use(middlewares ...Middleware) Router
}

// RouteGroup implements Router using http.ServeMux.
type RouteGroup struct {
	mux         *http.ServeMux
	prefix      string
	middlewares []Middleware
	routes      []string
}

// NewRouter creates a new router with an optional mux.
// If mux is nil, a new http.ServeMux will be created.
func NewRouter(mux *http.ServeMux) *RouteGroup {
	if mux == nil {
		mux = http.NewServeMux()
	}
	return &RouteGroup{
		mux:         mux,
		prefix:      "",
		middlewares: nil,
		routes:      []string{},
	}
}

// Mux returns the underlying http.ServeMux.
func (g *RouteGroup) Mux() *http.ServeMux {
	return g.mux
}

// joinPath safely joins URL path segments.
func joinPath(base, path string) string {
	if path == "" || path == "/" {
		return base
	}
	if base == "" || base == "/" {
		return path
	}
	return strings.TrimSuffix(base, "/") + "/" + strings.TrimPrefix(path, "/")
}

// Group creates a new RouteGroup with the given prefix and optional middlewares.
func (g *RouteGroup) Group(prefix string, middlewares ...Middleware) Router {
	// Ensure prefix starts with /
	if prefix != "" && !strings.HasPrefix(prefix, "/") {
		prefix = "/" + prefix
	}

	return &RouteGroup{
		mux:         g.mux,
		prefix:      joinPath(g.prefix, prefix),
		middlewares: appendMiddlewares(g.middlewares, middlewares),
		routes:      []string{},
	}
}

// Use appends middlewares to all routes registered after this call.
func (g *RouteGroup) Use(middlewares ...Middleware) Router {
	g.middlewares = appendMiddlewares(g.middlewares, middlewares)
	return g
}

// HandleFunc registers a handler function for the given method and pattern.
func (g *RouteGroup) HandleFunc(method, pattern string, handler http.HandlerFunc, middlewares ...Middleware) {
	fullPattern := joinPath(g.prefix, pattern)
	finalHandler := applyMiddlewares(handler, g.middlewares, middlewares)
	routeKey := method + " " + fullPattern
	g.mux.Handle(routeKey, finalHandler)
	g.routes = append(g.routes, routeKey)
}

// GetRoutes returns all registered routes for this group.
func (g *RouteGroup) GetRoutes() []string {
	return g.routes
}

// ServeHTTP implements the http.Handler interface.
func (g *RouteGroup) ServeHTTP(w http.ResponseWriter, r *http.Request) {
	g.mux.ServeHTTP(w, r)
}

// appendMiddlewares combines parent and new middlewares, filtering out nils.
func appendMiddlewares(parent, additional []Middleware) []Middleware {
	result := make([]Middleware, 0, len(parent)+len(additional))
	for _, mw := range parent {
		if mw != nil {
			result = append(result, mw)
		}
	}
	for _, mw := range additional {
		if mw != nil {
			result = append(result, mw)
		}
	}
	return result
}

// applyMiddlewares wraps handler with group and route-specific middlewares.
func applyMiddlewares(handler http.Handler, groupMW, routeMW []Middleware) http.Handler {
	// Apply route-specific middlewares first (innermost)
	for i := len(routeMW) - 1; i >= 0; i-- {
		if routeMW[i] != nil {
			handler = routeMW[i](handler)
		}
	}
	// Apply group middlewares (outermost)
	for i := len(groupMW) - 1; i >= 0; i-- {
		if groupMW[i] != nil {
			handler = groupMW[i](handler)
		}
	}
	return handler
}

// ErrNilRouter is returned when a nil router is passed to a register function.
var ErrNilRouter = errors.New("protogen: router is nil")

// ErrNilHandler is returned when a nil handler is passed to a register function.
var ErrNilHandler = errors.New("protogen: handler is nil")

// DefaultRouter creates a new router with a new ServeMux.
//
// Deprecated: Use NewRouter(nil) instead.
func DefaultRouter() *RouteGroup {
	return NewRouter(nil)
}

